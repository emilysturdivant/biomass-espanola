---
title: "Compare AGB maps"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

[GlobBiomass](http://globbiomass.org/wp-content/uploads/GB_Maps/Globbiomass_global_dataset.html)

```{r initialize, echo=FALSE, message=FALSE, warning=FALSE}
library('sf')
library('terra')
library('tidyverse')

source('src/R/initialize_vars.R')
agb_fp <- file.path(agb_dir, str_glue('agb_{agb_code}.tif'))
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

### All four externals

```{r side-by-side maps}
plot_agb_map <- function(x, mask_poly = NULL, borders = NULL, resolution = 200) {
  
  lyr_name <- x$name
  
  # Load AGB
  agb <- rast(x$fp)
  
  # Conditionally aggregate map based on resolution
  resx <- res(agb) %>% nth(1) #%>% signif(2)
  fact <- resolution/resx/113000
  agg_factor <- ifelse(fact >= 1.5, round(fact, 0), 1)
  if (agg_factor > 1) {
    agb <- terra::aggregate(agb, fact = agg_factor, fun = 'mean', na.rm = TRUE)
  } else if(fact < 1) {
    print('WARNING: input map resolution is greater than target')
  }
  
  # if(resx == 0.00022) {
  #   agg_fact = resolution/25
  #   agb <- terra::aggregate(agb, fact = 4)
  # } else if (resx > 0.00089) {
  #   print('NOTE: AGB map resolution is greater than 0.00089')
  # }
  
  # Convert raster to dataframe
  agb_a_df <- agb %>% as.data.frame(xy = T) %>% rename(agb = 3)

  if(is.null(mask_poly)){
      # Urban polygons
      tol <- 0.001
      urb_poly_fp <- file.path(tidy_dir, 'landcover', str_glue('lc2_urban_tol{tol}.gpkg'))
      if(!file.exists(urb_poly_fp)) {
        mask_poly <- st_read(lc_pols_fp) %>% 
          filter(LC == 2) %>% 
          st_simplify(dTolerance = tol) %>% 
          st_union()
        mask_poly %>% st_write(urb_poly_fp)
      } else {
        mask_poly <- st_read(urb_poly_fp)
      }
  }

  if(is.null(mask_poly)){
    # Haiti administrative boundaries
    borders <- st_read(file.path(tidy_dir, 'contextual_data', 'HTI_adm', 'HTI_adm1.shp'))
  }
  
  # Plot
  agb_map <- ggplot(agb_a_df) +
    # geom_raster(aes(x = x, y = y, fill = agb)) +
    geom_tile(aes(x = x, y = y, fill = agb)) +
    geom_sf(data = mask_poly, fill = "gray63", color = NA) +
    geom_sf(data = borders, fill = NA, color = "gray39", size = 0.3) +
    scale_fill_gradientn(expression(paste("Aboveground\nbiomass (Mg ha"^"-1", ")")), 
                         na.value = "transparent", 
                         colors = agb1_palette,
                         limits = c(0, 120),
                         oob = scales::squish
    ) +
    ggthemes::theme_map() +
    ggtitle(lyr_name) +
    theme(legend.position=c(0.23, 0.9),
          legend.title.align=0,
          legend.justification = c(1,1),
          legend.box.background = element_blank(),
          panel.grid.minor = element_blank(),
          axis.title = element_blank(), 
          plot.title = element_text(vjust = -8, hjust = 0.048)) 
}

# Urban polygons
tol <- 0.001
urb_poly_fp <- file.path(tidy_dir, 'landcover', str_glue('lc2_urban_tol{tol}.gpkg'))
if(!file.exists(urb_poly_fp)) {
  urban <- st_read(lc_pols_fp) %>% 
    filter(LC == 2) %>% 
    st_simplify(dTolerance = tol) %>% 
    st_union()
  urban %>% st_write(urb_poly_fp)
} else {
  urban <- st_read(urb_poly_fp)
}

# Haiti administrative boundaries
hti_adm1 <- st_read(file.path(tidy_dir, 'contextual_data', 'HTI_adm', 'HTI_adm1.shp'))

# List of AGB maps
agb_fps <- list(internal = list(name = 'This study',
                     fp = agb_fp),
                glob = list(name = 'GlobBiomass',
                     fp = glob_fp), 
                esa = list(name = 'CCI', 
                     fp = esa_fp), 
                avit = list(name = 'Avitabile',
                     fp = avit_fp), 
                bacc = list(name = 'Baccini',
                     fp = bacc_fp))
```


```{r individual maps}
bacc_map <- plot_agb_map(agb_fps$bacc, urban, hti_adm1, 100)
```


```{r side-by-side maps}
# Extract plot means for all AGB maps
maps <- agb_fps %>% 
  purrr::map(plot_agb_map, urban, hti_adm1, resolution = 400) 

# Set output dir for side-by-side maps
out_dir <- file.path(dirname(agb_fp), 'external_comparison', agb_code, 'sidebyside')
dir.create(out_dir)

# Ours, with GlobBiomass, ESA, and Baccini
(all_maps <- maps[c(1,2,3,5)] %>% 
  wrap_plots(nrow = 2, guides = 'collect'))
map_fp <- file.path(out_dir, str_glue("sidebyside_Us_GlobB_ESA_Bacc_400m.png"))
ggsave(map_fp, width=12, height=10, dpi=120)

# 4 external maps
(all_maps <- maps[c(4,2,3,5)] %>% 
  wrap_plots(nrow = 2, guides = 'collect'))
map_fp <- file.path(out_dir, str_glue("sidebyside_Avit_GlobB_ESA_Bacc_400m.png"))
ggsave(map_fp, width=12, height=10, dpi=120)

# All 5, with ours bigger
four <- ((maps$bacc + maps$avit) / (maps$glob + maps$esa)) &
  theme(legend.position = 'none')
(all_maps <- (maps$internal + plot_layout(guides = 'keep')) / four)
map_fp <- file.path(out_dir, str_glue("all5_400m.png"))
ggsave(map_fp, width=5, height=8, dpi=120)



# Layout maps
maps$avit + maps$glob +
  plot_layout(nrow = 2, guides = 'collect')

map_fp <- file.path(dirname(agb_fp), 'external_comparison', agb_code,
                    str_glue("sidebyside_GlobB_ESA.png"))
ggsave(map_fp, width=12, height=5, dpi=120)

# GlobBiomass v. ESA
maps$GlobBiomass + maps$ESA + plot_layout(guides = 'collect')
map_fp <- file.path(out_dir, str_glue("sidebyside_GlobB_ESA.png"))
ggsave(map_fp, width=12, height=5, dpi=120)

# Our AGB and ESA
maps$internal + maps$ESA + plot_layout(guides = 'collect')

maps_subset <- maps[c(1, 3)]
maps_subset %>% wrap_plots(guides = 'collect') +
  plot_annotation(tag_levels = list(names(maps_subset)))
map_fp <- file.path(out_dir, str_glue("sidebyside_{agb_code}_ESA.png"))
ggsave(map_fp, width=12, height=5, dpi=120)

# Separately
agb_map <- plot_agb_map(list(name = 'Internal', fp = agb_fp), urban, hti_adm1)
```

